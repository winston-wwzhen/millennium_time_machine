<view class="qcio-container">
  <!-- 0. æ³¨å†Œç•Œé¢ (æ–°ç”¨æˆ·) -->
  <view class="register-screen" wx:if="{{needsRegister}}">
    <view class="win98-window register-dialog">
      <view class="win98-title-bar">
        <view class="win98-title-text">QCIO æ–°ç”¨æˆ·æ³¨å†Œ</view>
        <view class="win98-title-controls">
          <button class="win98-btn-close" bindtap="goBack"></button>
        </view>
      </view>

      <view class="win98-window-body">
        <view class="register-header">
          <view class="big-icon">ğŸ“Ÿ</view>
          <text class="register-brand">æ¬¢è¿åŠ å…¥ QCIO 2005</text>
          <text class="register-subtitle">åƒç¦§å¹´ä»£çš„è™šæ‹Ÿç¤¾äº¤ä½“éªŒ</text>
        </view>

        <view class="register-fields" wx:if="{{!isRegistering}}">
          <!-- QCIO å·ç ï¼ˆä¸å¯æ›´æ”¹ï¼‰ -->
          <view class="field-row">
            <label>QCIO å·:</label>
            <view class="qcio-id-display">{{registerForm.qcio_id}}</view>
          </view>

          <!-- æ˜µç§°ï¼ˆæ˜¾ç¤ºï¼‰ -->
          <view class="field-row">
            <label>æ˜µç§°:</label>
            <view class="qcio-id-display">{{registerForm.nickname}}</view>
          </view>

          <!-- å¤´åƒé€‰æ‹© -->
          <view class="field-row">
            <label>é€‰æ‹©å¤´åƒ:</label>
            <view class="avatar-inline">
              <view
                class="avatar-item {{registerForm.avatar === item ? 'selected' : ''}}"
                wx:for="{{avatarList}}"
                wx:key="index"
                bindtap="selectAvatar"
                data-avatar="{{item}}"
              >
                {{item}}
              </view>
            </view>
          </view>

          <view class="register-footer-actions">
            <button class="win98-btn-primary" bindtap="submitRegister" disabled="{{isRegistering}}">
              ç«‹å³æ³¨å†Œ (R)
            </button>
            <button class="win98-btn-std" bindtap="goBack">å–æ¶ˆ</button>
          </view>
        </view>

        <!-- æ³¨å†Œè¿›åº¦ -->
        <view class="dialing-box" wx:else>
          <text class="dialing-status">æ­£åœ¨åˆ›å»ºè´¦å·...</text>
          <view class="win98-progress-container">
            <view class="win98-progress-fill" style="width: 100%"></view>
          </view>
          <text class="dialing-percent">è¯·ç¨å€™...</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 1. ç™»å½•è¦†ç›–å±‚ (æœªç™»å½•çŠ¶æ€) -->
  <view class="login-screen" wx:elif="{{!isLoggedIn}}">
    <view class="win98-window login-dialog">
      <view class="win98-title-bar">
        <view class="win98-title-text">QCIO 2005 ç™»å½•</view>
        <view class="win98-title-controls">
          <button class="win98-btn-close" bindtap="goBack"></button>
        </view>
      </view>

      <view class="win98-window-body">
        <view class="login-header">
          <view class="big-icon">ğŸ“Ÿ</view>
          <text class="login-brand">QCIO Messenger</text>
        </view>

        <view class="login-fields" wx:if="{{!isLoggingIn}}">
          <view class="field-row">
            <label>æ˜µç§°:</label>
            <view class="qcio-id-display">{{userProfile.nickname}}</view>
          </view>
          <view class="field-row">
            <label>QCIO è´¦å·:</label>
            <view class="qcio-id-display">{{userProfile.qcio_id}}</view>
          </view>
          <view class="field-row">
            <label>ç™»å½•å¯†ç :</label>
            <view class="qcio-id-display">******</view>
          </view>
          <view class="login-footer-actions">
            <button class="win98-btn-std" bindtap="doLogin">ç™»å½•(L)</button>
            <button class="win98-btn-std" bindtap="goBack">å–æ¶ˆ</button>
          </view>
        </view>

        <!-- æ‹¨å·è¿›åº¦ -->
        <view class="dialing-box" wx:else>
          <text class="dialing-status">æ­£åœ¨éªŒè¯èº«ä»½å¹¶ä¸‹è½½å¥½å‹åˆ—è¡¨...</text>
          <view class="win98-progress-container">
            <view class="win98-progress-fill" style="width: {{loginProgress}}%"></view>
          </view>
          <text class="dialing-percent">{{loginProgress}}%</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 2. ä¸»é¢æ¿å†…å®¹ (å·²ç™»å½•çŠ¶æ€) -->
  <view class="main-panel" wx:if="{{isLoggedIn}}">
    <view class="win98-window full-panel">
      <!-- æ ‡é¢˜æ ï¼šç§»é™¤äº†æ³¨é”€æŒ‰é’®ï¼Œä»…ä¿ç•™å…³é—­ -->
      <view class="win98-title-bar">
        <view class="win98-title-text">QCIO - {{userProfile.qcio_id}}</view>
        <view class="win98-title-controls">
          <button class="win98-btn-close" bindtap="goBack"></button>
        </view>
      </view>

      <!-- ç”¨æˆ·ä¿¡æ¯é¢æ¿ -->
      <view class="user-profile-bar">
        <view class="avatar-inset">
          <text class="avatar-emoji">ğŸ‘¤</text>
          <view class="online-status"></view>
        </view>
        <view class="profile-details">
          <view class="name-row">
            <text class="display-name" bindtap="openEditDialog" data-type="nickname">{{userProfile.nickname}}</text>
            <view class="level-display">
              <block wx:for="{{levelIcons}}" wx:key="index">
                <text class="lvl-ico">{{item}}</text>
              </block>
            </view>
          </view>
          <view class="id-row">QCIO: {{userProfile.qcio_id}}</view>
          <view class="sig-row" bindtap="openEditDialog" data-type="signature">
            {{userProfile.signature || 'ç‚¹å‡»ç¼–è¾‘ä¸ªæ€§ç­¾å...'}}
          </view>
        </view>
      </view>

      <!-- æ ‡ç­¾é¡µ -->
      <view class="qcio-tabs">
        <view class="qcio-tab {{activeTab === 'contacts' ? 'active' : ''}}" bindtap="switchTab" data-tab="contacts">è”ç³»äºº</view>
        <view class="qcio-tab {{activeTab === 'chats' ? 'active' : ''}}" bindtap="switchTab" data-tab="chats">ç¾¤èŠ</view>
        <view class="qcio-tab {{activeTab === 'zone' ? 'active' : ''}}" bindtap="switchTab" data-tab="zone">ç©ºé—´</view>
      </view>

      <!-- ç©ºé—´äºŒçº§Tabå¯¼èˆª (å›ºå®š) -->
      <view class="zone-sub-tabs" wx:if="{{activeTab === 'zone'}}">
        <view class="zone-sub-tab {{zoneSubTab === 'home' ? 'active' : ''}}" bindtap="switchZoneSubTab" data-subtab="home">ä¸»é¡µ</view>
        <view class="zone-sub-tab {{zoneSubTab === 'log' ? 'active' : ''}}" bindtap="switchZoneSubTab" data-subtab="log">æ—¥å¿—</view>
        <view class="zone-sub-tab {{zoneSubTab === 'msg' ? 'active' : ''}}" bindtap="switchZoneSubTab" data-subtab="msg">ç•™è¨€</view>
      </view>

      <!-- å†…å®¹åŒº -->
      <scroll-view class="list-container" scroll-y>
        <block wx:if="{{activeTab === 'contacts'}}">
          <view class="contact-group" wx:for="{{contactGroups}}" wx:key="name">
            <view class="group-title" bindtap="toggleGroup" data-index="{{index}}">
              <text class="arrow">{{item.expanded ? 'â–¼' : 'â–¶'}}</text>
              <text>{{item.name}} [{{item.onlineCount}}/{{item.contacts.length}}]</text>
            </view>
            <view class="contacts-sub-list" wx:if="{{item.expanded}}">
              <view class="contact-card" wx:for="{{item.contacts}}" wx:for-item="contact" wx:key="id" bindtap="openChat" data-contact="{{contact}}">
                <view class="c-avatar-box {{contact.online ? '' : 'offline'}}">{{contact.avatar}}</view>
                <view class="c-info">
                  <view class="c-name">{{contact.name}}</view>
                  <view class="c-sig">{{contact.status}}</view>
                </view>
              </view>
            </view>
          </view>
        </block>

        <!-- ç©ºé—´ Tab å†…å®¹ -->
        <block wx:if="{{activeTab === 'zone'}}">
          <!-- ä¸»é¡µå†…å®¹ -->
          <block wx:if="{{zoneSubTab === 'home'}}">
            <daily-checkin qcioId="{{userProfile.qcio_id}}" />
            <farm-badge qcioId="{{userProfile.qcio_id}}" />
          </block>

          <!-- æ—¥å¿—å†…å®¹ -->
          <block wx:elif="{{zoneSubTab === 'log'}}">
            <mood-log qcioId="{{userProfile.qcio_id}}" />
          </block>

          <!-- ç•™è¨€å†…å®¹ -->
          <block wx:elif="{{zoneSubTab === 'msg'}}">
            <step-counter
              qcioId="{{userProfile.qcio_id}}"
              nickname="{{userProfile.nickname}}"
              bindshare="onShareFromZone"
            />
            <guestbook />
          </block>
        </block>

        <!-- ç¾¤èŠ Tab å†…å®¹ -->
        <block wx:elif="{{activeTab === 'chats'}}">
          <message-list userProfile="{{userProfile}}" />
        </block>
      </scroll-view>

      <!-- çŠ¶æ€æ ï¼šè¿™é‡Œæ˜¯æ³¨é”€æŒ‰é’®çš„æ–°ä½ç½® -->
      <view class="qcio-status-bar">
        <view class="status-btn" bindtap="doLogout">æ³¨é”€(X)</view>
        <view class="status-right">
          <text>ğŸ”Š</text>
          <text>âš¡</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 3. è‡ªå®šä¹‰ Win98 é£æ ¼å¯¹è¯æ¡† -->
  <view class="win98-overlay" wx:if="{{showDialog}}">
    <view class="win98-window dialog-box">
      <view class="win98-title-bar">
        <view class="win98-title-text">{{dialogTitle}}</view>
        <view class="win98-title-controls">
          <button class="win98-btn-close" bindtap="closeDialog"></button>
        </view>
      </view>
      <view class="win98-window-body">
        <view class="dialog-content">
          <text class="dialog-label">è¯·è¾“å…¥æ–°å€¼:</text>
          <textarea 
            class="win98-input dialog-textarea" 
            value="{{dialogValue}}" 
            bindinput="onDialogInput"
            maxlength="{{dialogType === 'nickname' ? 12 : 50}}"
            auto-focus
          ></textarea>
        </view>
        <view class="dialog-actions">
          <button class="win98-btn-std" bindtap="confirmDialog">ç¡®å®š</button>
          <button class="win98-btn-std" bindtap="closeDialog">å–æ¶ˆ</button>
        </view>
      </view>
    </view>
  </view>
</view>