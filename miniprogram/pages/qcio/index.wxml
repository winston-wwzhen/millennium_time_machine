<view class="qcio-container">
  <!-- 0. 注册界面 (新用户) -->
  <view class="register-screen" wx:if="{{needsRegister}}">
    <view class="win98-window register-dialog">
      <view class="win98-title-bar">
        <view class="win98-title-text">QCIO AI模拟空间 - 新用户</view>
        <view class="win98-title-controls">
          <button class="win98-btn-close" bindtap="goBack">×</button>
        </view>
      </view>

      <view class="win98-window-body">
        <view class="register-header">
          <view class="big-icon">📟</view>
          <text class="register-brand">欢迎加入 QCIO AI模拟空间</text>
          <text class="register-subtitle">体验千禧年代的AI虚拟社交</text>
          <text class="register-note">✨ AI驱动 • 纯净怀旧 • 免费体验</text>
        </view>

        <view class="register-fields" wx:if="{{!isRegistering}}">
          <!-- QCIO 号码（不可更改） -->
          <view class="field-row">
            <label>QCIO 号:</label>
            <view class="qcio-id-display">{{registerForm.qcio_id}}</view>
          </view>

          <!-- 昵称（显示） -->
          <view class="field-row">
            <label>昵称:</label>
            <view class="qcio-id-display">{{registerForm.nickname}}</view>
          </view>

          <!-- 头像选择 -->
          <view class="field-row">
            <label>选择头像:</label>
            <view class="avatar-inline">
              <view
                class="avatar-item {{registerForm.avatar === item ? 'selected' : ''}}"
                wx:for="{{avatarList}}"
                wx:key="index"
                bindtap="selectAvatar"
                data-avatar="{{item}}"
              >
                {{item}}
              </view>
            </view>
          </view>

          <view class="register-footer-actions">
            <button class="win98-btn-primary" bindtap="submitRegister" disabled="{{isRegistering}}">
              立即注册 (R)
            </button>
            <button class="win98-btn-std" bindtap="goBack">取消</button>
          </view>
        </view>

        <!-- 注册进度 -->
        <view class="dialing-box" wx:else>
          <text class="dialing-status">正在创建账号...</text>
          <view class="win98-progress-container">
            <view class="win98-progress-fill" style="width: 100%"></view>
          </view>
          <text class="dialing-percent">请稍候...</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 1. 登录覆盖层 (未登录状态) -->
  <view class="login-screen" wx:elif="{{!isLoggedIn}}">
    <view class="win98-window login-dialog">
      <view class="win98-title-bar">
        <view class="win98-title-text">QCIO AI模拟空间 - 登录</view>
        <view class="win98-title-controls">
          <button class="win98-btn-close" bindtap="goBack">×</button>
        </view>
      </view>

      <view class="win98-window-body">
        <view class="login-header">
          <view class="big-icon">📟</view>
          <text class="login-brand">QCIO AI模拟空间</text>
          <text class="login-subtitle">与AI好友重温千禧记忆</text>
        </view>

        <view class="login-fields" wx:if="{{!isLoggingIn}}">
          <view class="field-row">
            <label>昵称:</label>
            <view class="qcio-id-display">{{userProfile.nickname}}</view>
          </view>
          <view class="field-row">
            <label>QCIO 账号:</label>
            <view class="qcio-id-display">{{userProfile.qcio_id}}</view>
          </view>
          <view class="field-row">
            <label>登录密码:</label>
            <view class="qcio-id-display">******</view>
          </view>
          <view class="login-footer-actions">
            <button class="win98-btn-std" bindtap="doLogin">登录(L)</button>
            <button class="win98-btn-std" bindtap="goBack">取消</button>
          </view>
        </view>

        <!-- 拨号进度 -->
        <view class="dialing-box" wx:else>
          <text class="dialing-status">正在验证身份并下载好友列表...</text>
          <view class="win98-progress-container">
            <view class="win98-progress-fill" style="width: {{loginProgress}}%"></view>
          </view>
          <text class="dialing-percent">{{loginProgress}}%</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 2. 主面板内容 (已登录状态) -->
  <view class="main-panel" wx:if="{{isLoggedIn}}">
    <view class="win98-window full-panel">
      <!-- 标题栏：移除了注销按钮，仅保留关闭 -->
      <view class="win98-title-bar">
        <view class="win98-title-text">QCIO AI模拟空间 - {{userProfile.qcio_id}}</view>
        <view class="win98-title-controls">
          <button class="win98-btn-close" bindtap="goBack">×</button>
        </view>
      </view>

      <!-- 用户信息面板 -->
      <view class="user-profile-bar">
        <view class="avatar-inset">
          <text class="avatar-emoji">👤</text>
          <view class="online-status"></view>
        </view>
        <view class="profile-details">
          <view class="name-row">
            <text class="display-name" bindtap="openEditDialog" data-type="nickname">{{userProfile.nickname}}</text>
            <view class="growth-display" bindtap="showLevelInfo">
              <block wx:for="{{growthIcons}}" wx:key="index">
                <text class="lvl-ico">{{item}}</text>
              </block>
            </view>
          </view>
          <view class="growth-title-row" wx:if="{{growthTitle}}">
            <text class="growth-title-text">{{growthTitle}}</text>
          </view>
          <view class="id-row">QCIO: {{userProfile.qcio_id}}</view>
          <view class="sig-row" bindtap="openEditDialog" data-type="signature">
            {{userProfile.signature || '点击编辑个性签名...'}}
          </view>
        </view>
        <!-- 钱包显示区域 -->
        <view class="wallet-display" bindtap="showWalletInfo">
          <view class="wallet-item">
            <text class="wallet-icon">💰</text>
            <text class="wallet-amount">{{wallet.coins || 0}}</text>
          </view>
          <view class="wallet-item">
            <text class="wallet-icon">💎</text>
            <text class="wallet-amount">{{wallet.qpoints || 0}}</text>
          </view>
        </view>
      </view>

      <!-- 标签页 -->
      <view class="qcio-tabs">
        <view class="qcio-tab {{activeTab === 'contacts' ? 'active' : ''}}" bindtap="switchTab" data-tab="contacts">联系人</view>
        <view class="qcio-tab {{activeTab === 'chats' ? 'active' : ''}}" bindtap="switchTab" data-tab="chats">群聊</view>
        <view class="qcio-tab {{activeTab === 'zone' ? 'active' : ''}}" bindtap="switchTab" data-tab="zone">空间</view>
      </view>

      <!-- 空间二级Tab导航 (固定) -->
      <view class="zone-sub-tabs" wx:if="{{activeTab === 'zone'}}">
        <view class="zone-sub-tab {{zoneSubTab === 'home' ? 'active' : ''}}" bindtap="switchZoneSubTab" data-subtab="home">主页</view>
        <view class="zone-sub-tab {{zoneSubTab === 'log' ? 'active' : ''}}" bindtap="switchZoneSubTab" data-subtab="log">日志</view>
        <view class="zone-sub-tab {{zoneSubTab === 'msg' ? 'active' : ''}}" bindtap="switchZoneSubTab" data-subtab="msg">留言</view>
      </view>

      <!-- 内容区 -->
      <scroll-view class="list-container" scroll-y>
        <block wx:if="{{activeTab === 'contacts'}}">
          <view class="contact-group" wx:for="{{contactGroups}}" wx:key="name">
            <view class="group-title" bindtap="toggleGroup" data-index="{{index}}">
              <text class="arrow">{{item.expanded ? '▼' : '▶'}}</text>
              <text>{{item.name}} [{{item.onlineCount}}/{{item.contacts.length}}]</text>
            </view>
            <view class="contacts-sub-list" wx:if="{{item.expanded}}">
              <view class="contact-card" wx:for="{{item.contacts}}" wx:for-item="contact" wx:key="id" bindtap="openChat" data-contact="{{contact}}">
                <view class="c-avatar-box {{contact.online ? '' : 'offline'}}">{{contact.avatar}}</view>
                <view class="c-info">
                  <view class="c-name">{{contact.name}}</view>
                  <view class="c-sig">{{contact.status}}</view>
                </view>
              </view>
            </view>
          </view>
        </block>

        <!-- 空间 Tab 内容 -->
        <block wx:if="{{activeTab === 'zone'}}">
          <!-- 主页内容 -->
          <block wx:if="{{zoneSubTab === 'home'}}">
            <daily-checkin qcioId="{{userProfile.qcio_id}}" bindcheckin="onCheckInSuccess" />

            <!-- 等级经验进度条 -->
            <view class="level-section" wx:if="{{growthInfo}}">
              <view class="level-header">
                <text class="level-title-text">🎯 成长值</text>
                <level-badge level="{{growthInfo.level}}" size="medium" showTitle="{{true}}" />
              </view>
              <exp-progress
                current-exp="{{growthInfo.experience}}"
                level="{{growthInfo.level}}"
                showText="{{true}}"
              />
              <!-- 每日等级奖励 -->
              <view class="daily-reward-section" wx:if="{{growthInfo.daily_reward.daily_bonus_coins || growthInfo.daily_reward.daily_bonus_qpoints}}">
                <view class="reward-info">
                  <text class="reward-label">等级奖励: </text>
                  <text class="reward-amount" wx:if="{{growthInfo.daily_reward.daily_bonus_coins}}">
                    💰{{growthInfo.daily_reward.daily_bonus_coins}}
                  </text>
                  <text class="reward-amount" wx:if="{{growthInfo.daily_reward.daily_bonus_qpoints}}">
                    💎{{growthInfo.daily_reward.daily_bonus_qpoints}}
                  </text>
                </view>
                <button
                  class="reward-claim-btn {{growthInfo.has_claimed_daily ? 'claimed' : ''}}"
                  bindtap="onClaimDailyReward"
                  disabled="{{growthInfo.has_claimed_daily}}"
                >
                  {{growthInfo.has_claimed_daily ? '已领取' : '领取奖励'}}
                </button>
              </view>
            </view>

            <!-- 农场入口 -->
            <view class="farm-entry-card" bindtap="goToFarm">
              <view class="farm-entry-icon">🌾</view>
              <view class="farm-entry-info">
                <text class="farm-entry-title">我的农场</text>
                <text class="farm-entry-desc">种植作物，收获金币</text>
              </view>
              <view class="farm-entry-arrow">→</view>
            </view>
          </block>

          <!-- 日志内容 -->
          <block wx:elif="{{zoneSubTab === 'log'}}">
            <mood-log qcioId="{{userProfile.qcio_id}}" bindlogpublished="onLogPublished" />
          </block>

          <!-- 留言内容 -->
          <block wx:elif="{{zoneSubTab === 'msg'}}">
            <step-counter
              qcioId="{{userProfile.qcio_id}}"
              nickname="{{userProfile.nickname}}"
            />
            <guestbook />
          </block>
        </block>

        <!-- 群聊 Tab 内容 -->
        <block wx:elif="{{activeTab === 'chats'}}">
          <message-list userProfile="{{userProfile}}" />
        </block>
      </scroll-view>

      <!-- 状态栏：这里是注销按钮的新位置 -->
      <view class="qcio-status-bar">
        <view class="status-btn" bindtap="doLogout">注销(X)</view>
        <view class="status-right">
          <text>🔊</text>
          <text>⚡</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 3. 自定义 Win98 风格对话框 -->
  <view class="win98-overlay" wx:if="{{showDialog}}">
    <view class="win98-window dialog-box">
      <view class="win98-title-bar">
        <view class="win98-title-text">{{dialogTitle}}</view>
        <view class="win98-title-controls">
          <button class="win98-btn-close" bindtap="closeDialog"></button>
        </view>
      </view>
      <view class="win98-window-body">
        <view class="dialog-content">
          <text class="dialog-label">请输入新值:</text>
          <textarea
            class="win98-input dialog-textarea"
            value="{{dialogValue}}"
            bindinput="onDialogInput"
            maxlength="{{dialogType === 'nickname' ? 12 : 50}}"
            auto-focus
          ></textarea>
        </view>
        <view class="dialog-actions">
          <button class="win98-btn-std" bindtap="confirmDialog">确定</button>
          <button class="win98-btn-std" bindtap="closeDialog">取消</button>
        </view>
      </view>
    </view>
  </view>

  <!-- 4. 钱包信息弹窗 -->
  <view class="win98-overlay" wx:if="{{showWalletInfo}}">
    <view class="win98-window wallet-info-box">
      <view class="win98-title-bar">
        <view class="win98-title-text">💰 QCIO 钱包说明</view>
        <view class="win98-title-controls">
          <button class="win98-btn-close" bindtap="closeWalletInfo"></button>
        </view>
      </view>
      <view class="win98-window-body">
        <view class="wallet-info-content">

          <!-- 金币说明 -->
          <view class="currency-section">
            <view class="currency-title">💰 金币</view>
            <view class="currency-desc">基础货币，用于日常游戏</view>
            <view class="info-section">
              <text class="info-label">获取方式：</text>
              <view class="info-list">
                <text class="info-item">• 每日签到 +10金币</text>
                <text class="info-item">• 发布心情日志 +5金币</text>
                <text class="info-item">• 聊天互动 +1金币/条</text>
                <text class="info-item">• 农场收获 +10~50金币</text>
              </view>
            </view>
          </view>

          <view class="divider-line"></view>

          <!-- Q点说明 -->
          <view class="currency-section">
            <view class="currency-title">💎 Q点</view>
            <view class="currency-desc">珍稀货币，解锁VIP特权</view>
            <view class="info-section">
              <text class="info-label">获取方式：</text>
              <view class="info-list">
                <text class="info-item">• VIP兑换码奖励</text>
                <text class="info-item">• 成长值提升 +5Q点</text>
                <text class="info-item">• 成就解锁 +3~10Q点</text>
              </view>
            </view>
          </view>

        </view>
        <view class="dialog-actions">
          <button class="win98-btn-std" bindtap="closeWalletInfo">知道了</button>
        </view>
      </view>
    </view>
  </view>

  <!-- 5. 注销确认弹窗 -->
  <view class="win98-overlay" wx:if="{{showLogoutDialog}}">
    <view class="win98-window logout-dialog-box">
      <view class="win98-title-bar">
        <view class="win98-title-text">⚠️ 安全退出确认</view>
        <view class="win98-title-controls">
          <button class="win98-btn-close" bindtap="cancelLogout">×</button>
        </view>
      </view>
      <view class="win98-window-body">
        <view class="logout-dialog-content">
          <view class="logout-icon">📟</view>
          <view class="logout-message">确定要安全退出 QCIO 吗？</view>
          <view class="logout-submessage">退出后您的在线状态将显示为离线</view>
        </view>
        <view class="dialog-actions">
          <button class="win98-btn-std" bindtap="confirmLogout">确定退出</button>
          <button class="win98-btn-std" bindtap="cancelLogout">取消</button>
        </view>
      </view>
    </view>
  </view>

  <!-- 6. 等级详情弹窗 -->
  <view class="win98-overlay" wx:if="{{showLevelInfo}}">
    <view class="win98-window level-info-box">
      <view class="win98-title-bar">
        <view class="win98-title-text">🎯 成长值详情</view>
        <view class="win98-title-controls">
          <button class="win98-btn-close" bindtap="closeLevelInfo">×</button>
        </view>
      </view>
      <view class="win98-window-body">
        <scroll-view class="level-info-scroll" scroll-y>
          <view class="level-info-content">
            <!-- 等级展示 -->
            <view class="level-display-main">
              <view class="level-icon-large">{{growthInfo.level_icon || '★'}}</view>
              <view class="level-number">Lv.{{growthInfo.level || 1}}</view>
              <view class="level-title">{{growthInfo.level_title || '初入江湖'}}</view>
            </view>

          <!-- 经验进度 -->
          <view class="level-exp-section">
            <view class="exp-label">当前经验</view>
            <view class="exp-value">{{growthInfo.level_exp || 0}} / {{growthInfo.next_level_exp || 50}}</view>
            <view class="exp-bar-bg">
              <view class="exp-bar-fill" style="width: {{growthInfo.progress || 0}}%"></view>
            </view>
            <view class="exp-percent">{{growthInfo.progress || 0}}%</view>
          </view>

          <!-- 升级还需 -->
          <view class="level-need-section">
            <text class="need-label">距离升级还需：</text>
            <text class="need-value">{{growthInfo.need_exp || 50}} 经验</text>
          </view>

          <!-- 总经验 -->
          <view class="level-total-section">
            <text class="total-label">累计总经验：</text>
            <text class="total-value">{{growthInfo.total_experience || 0}}</text>
          </view>

          <!-- 经验获取指南 -->
          <view class="exp-guide-section">
            <view class="guide-title">📝 经验获取指南</view>
            <view class="guide-list">
              <view class="guide-item">
                <text class="guide-icon">💬</text>
                <text class="guide-text">聊天发言 +2经验/条 (每日上限100)</text>
              </view>
              <view class="guide-item">
                <text class="guide-icon">📝</text>
                <text class="guide-text">发布心情日志 +10经验/篇 (每日上限50)</text>
              </view>
              <view class="guide-item">
                <text class="guide-icon">👣</text>
                <text class="guide-text">访问他人空间 +3经验/次 (每日上限60)</text>
              </view>
              <view class="guide-item">
                <text class="guide-icon">🌾</text>
                <text class="guide-text">农场收获 +5经验/次 (每日上限100)</text>
              </view>
              <view class="guide-item">
                <text class="guide-icon">✅</text>
                <text class="guide-text">每日签到 +10经验 (每日1次)</text>
              </view>
              <view class="guide-item">
                <text class="guide-icon">⏰</text>
                <text class="guide-text">在线挂机 +1经验/分钟 (每10分钟结算，每日上限600)</text>
              </view>
              <view class="guide-item">
                <text class="guide-icon">💎</text>
                <text class="guide-text">VIP会员额外获得 ×1.5~2.0 经验加成</text>
              </view>
            </view>
          </view>
          </view>
        </scroll-view>

        <view class="dialog-actions">
          <button class="win98-btn-std" bindtap="closeLevelInfo">关闭</button>
        </view>
      </view>
    </view>
  </view>

  <!-- 7. 彩蛋发现弹窗 -->
  <egg-discovery-dialog
    show="{{showEggDiscoveryDialog}}"
    eggName="{{eggDiscoveryData.name}}"
    eggDescription="{{eggDiscoveryData.description}}"
    eggRarity="{{eggDiscoveryData.rarity}}"
    eggRarityName="{{eggDiscoveryData.rarityName}}"
    eggRewardText="{{eggDiscoveryData.rewardText}}"
    bindclose="hideEggDiscoveryDialog">
  </egg-discovery-dialog>
</view>
