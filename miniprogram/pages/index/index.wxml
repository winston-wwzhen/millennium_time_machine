<view class="desktop {{showBlueScreen ? 'blue-screen' : ''}}" style="background-color: {{desktopBackgrounds[desktopBgIndex]}};" bindlongpress="onDesktopLongPress" bindtap="onDesktopTap" catchtap="onDesktopTap">
  <!-- 蓝屏彩蛋覆盖层 -->
  <view class="blue-screen-overlay" wx:if="{{showBlueScreen}}">
    <view class="bsod-content">
      <text class="bsod-title">Windows</text>
      <text class="bsod-text">出现了一个致命错误</text>
      <text class="bsod-text">按 Ctrl+Alt+Del 重启</text>
      <text class="bsod-code">0x000000ED: UNMOUNTABLE_BOOT_VOLUME</text>
      <text class="bsod-hint">那个年代的噩梦...彩蛋发现！</text>
    </view>
  </view>

  <!-- 桌面图标区域 - 自动换列布局 -->
  <view class="icon-grid" catchtap="onIconGridTap">
    <block wx:for="{{desktopIcons}}" wx:key="id">
      <view class="desktop-icon" id="{{item.id}}" bindtap="onIconTap" data-path="{{item.path}}">
        <view class="icon-img">{{item.icon}}</view>
        <text class="icon-label">{{item.name}}</text>
      </view>
    </block>
    <!-- 隐藏图标彩蛋 -->
    <view class="desktop-icon hidden-icon" wx:if="{{showHiddenIcon}}" bindtap="onHiddenIconTap">
      <view class="icon-img">🎮</view>
      <text class="icon-label">???</text>
    </view>
  </view>

  <!-- 桌面右下角隐藏区域 - 点击触发隐藏图标 -->
  <view class="hidden-trigger" bindtap="toggleHiddenIcon"></view>

  <!-- 桌面助手：小狮子 (Office Assistant 风格) -->
  <view class="desktop-agent {{isDragging ? 'dragging' : ''}} {{isMidnightEgg ? 'midnight-glow' : ''}}" style="transform: translate({{agentTranslateX}}px, {{agentTranslateY}}px);"
        catchtouchstart="onAgentDragStart" catchtouchmove="onAgentDragMove" catchtouchend="onAgentDragEnd">
    <view class="agent-bubble {{showMessage ? 'show' : ''}}" wx:if="{{showMessage}}">
      <text>{{agentMessage}}</text>
    </view>
    <view class="agent-body agent-{{agentMood}}">🦁</view>
  </view>

  <!-- 任务栏 -->
  <view class="taskbar" bindtap="onTaskbarTap">
    <view class="start-button {{showStartMenu ? 'active' : ''}}" bindtap="toggleStartMenu" catchtap="toggleStartMenu">
      <image class="win-logo" src="../../images/borders/border_win98.png" mode="aspectFit"></image>
      <text>Start</text>
    </view>

    <view class="taskbar-divider"></view>

    <view class="task-items">
      <!-- 运行中的任务 -->
    </view>

    <view class="system-tray">
      <view class="network-wrapper">
        <view class="tray-icon network-icon {{networkConnected ? 'online' : 'offline'}}" bindtap="onNetworkIconTap">
          {{networkConnected ? '🌐' : '❌'}}
        </view>
        <!-- 网络信息气泡 -->
        <view class="network-bubble {{showNetworkInfo ? 'show' : ''}}" wx:if="{{showNetworkInfo}}">
          <text class="network-status-text">{{networkConnected ? '网络已连接' : '网络未连接'}}</text>
          <text class="network-speed-text">下载: {{networkSpeed.down}} MB/s</text>
          <text class="network-speed-text">上传: {{networkSpeed.up}} MB/s</text>
        </view>
      </view>
      <view class="tray-icon">🔊</view>
      <view class="system-time" bindtap="onTimeTap">{{systemTime}}</view>
    </view>
  </view>

  <!-- 开始菜单遮罩 (点击关闭) -->
  <view class="start-menu-mask" wx:if="{{showStartMenu}}" catchtap="toggleStartMenu"></view>

  <!-- 开始菜单 (弹出层) -->
  <view class="start-menu" wx:if="{{showStartMenu}}">
    <!-- 用户横幅 -->
    <view class="user-banner">
      <view class="user-avatar">👤</view>
      <view class="user-info">
        <text class="user-name">管理员</text>
        <text class="user-status">在线</text>
      </view>
    </view>
    <!-- 菜单项 -->
    <view class="menu-items">
      <view class="menu-item submenu" catchtap="toggleSubmenu">
        <text class="menu-icon">📂</text>
        <text class="menu-text">程序</text>
        <text class="submenu-arrow {{showSubmenu ? 'expanded' : ''}}">{{showSubmenu ? '▾' : '▸'}}</text>
      </view>
      <view class="menu-item" bindtap="onIconTap" data-path="/pages/my-documents/index">
        <text class="menu-icon">📄</text>
        <text class="menu-text">我的文档</text>
      </view>
      <view class="menu-item" bindtap="onIconTap" data-path="/pages/my-computer/index">
        <text class="menu-icon">💻</text>
        <text class="menu-text">我的电脑</text>
      </view>
      <view class="menu-item">
        <text class="menu-icon">⚙️</text>
        <text class="menu-text">设置</text>
      </view>
      <view class="menu-item" bindtap="onIconTap" data-path="/pages/about/index">
        <text class="menu-icon">❓</text>
        <text class="menu-text">帮助</text>
      </view>
      <view class="menu-line"></view>
      <view class="menu-item shutdown-item">
        <text class="menu-icon">🔌</text>
        <text class="menu-text">关机...</text>
      </view>
    </view>
  </view>

  <!-- 程序子菜单 (独立弹出层) -->
  <view class="submenu-popup {{showSubmenu ? 'show' : ''}}" catchtap="stopPropagation">
    <view class="submenu-item" catchtap="onIconTap" data-path="/pages/tetris/index">
      <text class="submenu-icon">🎮</text>
      <text class="submenu-text">俄罗斯方块</text>
    </view>
    <view class="submenu-item" catchtap="onIconTap" data-path="/pages/star-explorer/index">
      <text class="submenu-icon">🌌</text>
      <text class="submenu-text">星际探索</text>
    </view>
    <view class="submenu-item" catchtap="onIconTap" data-path="/pages/mars/index">
      <text class="submenu-icon">🪐</text>
      <text class="submenu-text">火星翻译</text>
    </view>
  </view>

  <!-- 右键菜单 (弹出层) -->
  <view class="context-menu" wx:if="{{showContextMenu}}" style="left: {{contextMenuX}}px; top: {{contextMenuY}}px;" catchtap="hideContextMenu">
    <view class="context-menu-item" bindtap="refreshDesktop">
      <text class="context-icon">🔄</text> 刷新(E)
    </view>
    <view class="menu-line"></view>
    <view class="context-menu-item" bindtap="arrangeIcons">
      <text class="context-icon">📋</text> 排列图标(A)
    </view>
    <view class="context-menu-item" bindtap="newFolder">
      <text class="context-icon">📁</text> 新建(W)
    </view>
    <view class="menu-line"></view>
    <view class="context-menu-item" bindtap="showEasterEggs">
      <text class="context-icon">🥚</text> 彩蛋收集(G)
    </view>
    <view class="context-menu-item" bindtap="showProperties">
      <text class="context-icon">ℹ️</text> 属性(R)
    </view>
  </view>

  <!-- Win98 错误弹窗 -->
  <view class="win98-overlay" wx:if="{{showErrorDialog}}" bindtap="hideErrorDialog">
    <view class="win98-window error-dialog" catchtap="stopPropagation">
      <view class="win98-title-bar">
        <view class="win98-title-text">⚠️ 错误</view>
        <view class="win98-title-controls">
          <button class="win98-btn-close" bindtap="hideErrorDialog">×</button>
        </view>
      </view>
      <view class="win98-window-body">
        <view class="error-dialog-content">
          <view class="error-icon">❌</view>
          <view class="error-messages">
            <text class="error-title">文件已损坏</text>
            <text class="error-text">无法打开该程序。</text>
            <text class="error-text">请尝试重新安装。</text>
            <text class="error-code">错误代码: 0x80070002</text>
          </view>
        </view>
        <view class="dialog-actions">
          <button class="win98-btn-std" bindtap="hideErrorDialog">确定</button>
        </view>
      </view>
    </view>
  </view>

  <!-- 日期弹窗遮罩 (点击外部关闭) -->
  <view class="start-menu-mask" wx:if="{{showDateDialog}}" catchtap="hideDateDialog"></view>

  <!-- 日期弹窗 - Windows风格右下角弹出 -->
  <view class="date-dialog" wx:if="{{showDateDialog}}" catchtap="stopPropagation">
    <view class="date-dialog-content">
      <!-- 日历头部：年月 -->
      <view class="calendar-header">
        <text class="calendar-year">{{calendarYear}}</text>
        <text class="calendar-title">年</text>
        <text class="calendar-month">{{calendarMonth}}</text>
        <text class="calendar-title">月</text>
      </view>

      <!-- 星期标题行 -->
      <view class="weekday-header">
        <text class="weekday-title">日</text>
        <text class="weekday-title">一</text>
        <text class="weekday-title">二</text>
        <text class="weekday-title">三</text>
        <text class="weekday-title">四</text>
        <text class="weekday-title">五</text>
        <text class="weekday-title">六</text>
      </view>

      <!-- 日历网格 -->
      <view class="calendar-grid">
        <block wx:for="{{calendarDays}}" wx:key="index">
          <view class="calendar-day-cell {{item.isToday ? 'today' : ''}}" wx:if="{{item.day !== 0}}">
            {{item.day}}
          </view>
          <view class="calendar-day-cell" wx:else></view>
        </block>
      </view>

      <!-- 日期信息 -->
      <view class="date-info">
        <view class="info-row">
          <text class="info-label">当前:</text>
          <text class="info-value">{{fullDateTime}}</text>
        </view>
        <view class="info-row">
          <text class="info-label">农历:</text>
          <text class="info-value">{{lunarDate}}</text>
        </view>
      </view>
    </view>
  </view>
</view>