<view class="desktop" style="padding-top: {{capsulePadding}}px;">
  <view class="window-frame chat-main">
    <!-- 标题栏：显示群头像和群名称 -->
    <view class="title-bar chat-title-bar">
      <view class="group-info">
        <view class="group-title-avatar">{{groupAvatar}}</view>
        <view class="title-text">{{groupName}} ({{memberCount}}人)</view>
      </view>
      <view class="btn-close" bindtap="goBack">×</view>
    </view>

    <!-- 群成员列表（可折叠） -->
    <view class="members-section">
      <view class="members-header" bindtap="toggleMembers">
        <text class="members-toggle">{{showMembers ? '▼' : '▶'}}</text>
        <text class="members-title">群成员 ({{groupMembers.length}})</text>
      </view>
      <view class="members-list" wx:if="{{showMembers}}">
        <view class="member-item" wx:for="{{groupMembers}}" wx:key="name">
          <text class="member-avatar">{{item.avatar}}</text>
          <text class="member-name">{{item.name}}</text>
        </view>
      </view>
    </view>

    <!-- 提示信息 -->
    <view class="warning-tip">⚠️ 这是虚拟群聊，机器人随机发言，仅供娱乐</view>

    <!-- 聊天记录区 -->
    <scroll-view class="chat-history" scroll-y="true" scroll-into-view="{{scrollToView}}">
      <block wx:for="{{chatList}}" wx:key="index">
        <!-- AI消息（带发言者名字） -->
        <view class="chat-item left" wx:if="{{item.type === 'ai'}}">
          <view class="avatar ai-avatar">{{item.speakerAvatar || groupAvatar}}</view>
          <view class="message-content">
            <view class="speaker-name">{{item.speakerName}}</view>
            <view class="bubble ai-bubble">
              <text user-select="true">{{item.content}}</text>
            </view>
          </view>
        </view>

        <!-- 用户消息 -->
        <view class="chat-item right" wx:else>
          <view class="bubble my-bubble">
            <text user-select="true">{{item.content}}</text>
          </view>
          <view class="avatar my-avatar">{{myAvatar}}</view>
        </view>
      </block>
      <view id="msg-bottom" style="height: 1px;"></view>
    </scroll-view>

    <!-- 输入区域 -->
    <view class="chat-input-area">
      <textarea
        class="chat-input"
        value="{{chatInput}}"
        bindinput="onChatInput"
        bindconfirm="sendMessage"
        cursor-spacing="20"
        confirm-type="send"
      ></textarea>
      <view class="chat-actions">
        <view class="retro-btn sm-btn" bindtap="goBack">关闭(C)</view>
        <view class="retro-btn sm-btn primary" bindtap="sendMessage">发送(S)</view>
      </view>
    </view>
  </view>
</view>

<!-- 彩蛋发现弹窗 -->
<egg-discovery-dialog
  show="{{showEggDiscoveryDialog}}"
  eggName="{{eggDiscoveryData.name}}"
  eggDescription="{{eggDiscoveryData.description}}"
  eggRarity="{{eggDiscoveryData.rarity}}"
  eggRarityName="{{eggDiscoveryData.rarityName}}"
  eggRewardText="{{eggDiscoveryData.rewardText}}"
  bindclose="hideEggDiscoveryDialog">
</egg-discovery-dialog>
