# 千禧时光机 (old_story)

> 重现 2005 年 QQ 空间/QQ 聊天的怀旧小程序

一个充满非主流、火星文、伤感情怀的微信小程序，带你回到千禧年代的互联网记忆。

---

## 项目简介

"千禧时光机"是一个复古风格的社交模拟小程序，模拟 Windows 98 桌面和 2005 年左右的 QQ 空间、QQ 聊天体验。用户可以：

- **Windows 98 桌面** - 怀旧的操作系统界面，可拖拽的小狮子助手
- **网上邻居** - 模拟拨号上网，连接后才能使用 AI 功能
- **创建 5 位数字的 QCIO 账号**（类似 QQ 号）
- 与 100 个 AI 网友聊天，每个都有独特的个性
- 加入 6 个 AI 群聊，体验群聊氛围
- 发布空间心情日志
- 玩心情农场小游戏
- 浏览他人空间，踩一踩留言
- 邀请好友访问自己的空间
- **内置小游戏** - 俄罗斯方块、星际探索、火星翻译等

---

## 功能特性

### Windows 98 桌面系统

| 功能 | 说明 |
|------|------|
| 桌面图标 | 我的电脑、网管系统、我的文档、回收站、浏览器、QCIO、非主流相机 |
| 开始菜单 | 程序子菜单（小游戏）、设置、帮助、关机 |
| 任务栏 | Start 按钮、运行任务显示、系统托盘（网络状态、音量、时间） |
| 网管系统 | 双代币管理、拨号连接模拟、时光币兑换网费 |
| 网络状态 | 右下角显示连接状态，断网时需要通过网管系统重连 |
| AI 错误处理 | 429、超时等错误提示为"网络断开"，引导用户重连 |
| 小狮子助手 | 可拖拽的桌面助手，随机互动消息 |

### 双代币系统

**游戏循环**：
1. 新用户注册获得 30 天免费网费（43,200 分钟）
2. 每日登录自动扣除 1 天网费（1,440 分钟）
3. 探索桌面发现彩蛋，获得时光币奖励
4. 在网管系统用时光币兑换更多网费
5. 使用网费解锁 AI 聊天等功能

| 代币 | 获取方式 | 用途 |
|------|----------|------|
| 💎 时光币 | 发现彩蛋奖励 | 兑换网费、CDK等 |
| 🌐 网费 | 初始30天、时光币兑换 | AI 功能消耗 |

**彩蛋系统**：
- 12 个隐藏彩蛋，分布在桌面各处
- 不同稀有度：普通、稀有、史诗、传说
- 奖励 400-10000 时光币不等
- 成就徽章收集
- 云端存储，跨设备同步

### 桌面应用

| 应用 | 图标 | 说明 |
|------|------|------|
| 我的电脑 | 💻 | Win98 风格窗口，显示系统信息和驱动器 |
| 网管系统 | ⚙️ | 双代币管理、时光币兑换网费、拨号连接 |
| 我的文档 | 📁 | Win98 风格文件管理器 |
| 回收站 | 🗑️ | 回收站界面 |
| 浏览器 | 🌐 | 千禧浏览器 |
| QCIO | 📟 | QCIO 社交空间 |
| 非主流相机 | 📸 | 头像生成器 |

**开始菜单 - 程序子菜单**：
- 俄罗斯方块 🎮
- 星际探索 🌌
- 火星翻译 🪐

### QCIO 社交系统

| 功能 | 说明 |
|------|------|
| 账号系统 | 5 位数字账号（10000-99999），固定密码 123456 |
| 个人资料 | 昵称、头像、签名、等级、在线状态 |
| 空间系统 | 访问量统计、访客记录、留言板 |
| 好友系统 | 从 100 个 AI 网友中随机分配 20 个好友 |
| 踩一踩 | 每天可踩好友空间，自动留言互动 |
| 邀请访问 | 分享链接邀请好友踩空间 |
| 访客页面 | 独立访问页面，查看他人空间 |

### AI 聊天系统

**36 种聊天模式**，包括但不限于：

| 模式 | 风格 | 示例 |
|------|------|------|
| qingwu | 轻舞飞扬（非主流） | "滴~ 莪湜輕舞飛颺..." |
| sadsoul | 忧郁王子 | "唉，夜空中的星星好寂寞..." |
| netadmin | 网管小哥 | "重启试试" |
| fortune_teller | 算命大师 | "卦象显示..." |
| mars | 火星文转换 | 输入"你好" -> "伱好ㄋ" |
| joker | 段子手 | 输出搞笑段子 |

**100 个 AI 网友**，分为 12 个分组：

| 分组 | 人数 | 风格 |
|------|------|------|
| 葬爱家族 | 22人 | 非主流火星文 |
| 网游开黑 | 6人 | 游戏爱好者 |
| 网吧常驻 | 6人 | 技术、网吧 |
| 网络评论家 | 7人 | 键盘侠、吐槽 |
| 神秘人士 | 9人 | 玄学、中二 |
| 情感咨询 | 6人 | 恋爱、八卦 |
| 学霸联盟 | 7人 | 学习、技术 |
| 文艺青年 | 8人 | 诗歌、古风 |
| 娱乐达人 | 7人 | 电影、音乐 |
| 佛系一族 | 5人 | 禅意、极简 |
| 普通人 | 7人 | 日常生活 |
| 工具人 | 10人 | 转换功能 |

### 群聊系统

**6 个群聊**，每个群 18-24 人：

| 群名 | 人数 | 风格 |
|------|------|------|
| 葬爱网游家族 | 24人 | qingwu |
| 网吧技术联盟 | 20人 | netadmin |
| 神秘学园 | 20人 | fortune_teller |
| 情感八卦圈 | 21人 | love_expert |
| 学霸文艺社 | 19人 | nerd |
| 普通生活馆 | 18人 | down_to_earth |

**群聊发言机制**：
- 每次发消息随机选择 1-6 个群成员回复
- 概率分布：1人40%、2人30%、3人15%、4人8%、5人5%、6人2%
- AI 回复之间有 0.8-1.8 秒随机延迟

### 踩一踩系统

- **每日限制**：每个用户每天只能踩同一空间一次
- **自动留言**：踩过后自动在对方留言板生成随机留言
- **访客统计**：记录历史访问量和今日访问量
- **最近访客**：显示最近 10 位访客信息
- **分享功能**：可分享自己的空间链接给好友

---

## 技术架构

### 前端技术

- **框架**: 微信小程序原生框架
- **语言**: WXML + WXSS + JavaScript
- **UI**: 复古风格，模拟 QQ 2005 界面

### 后端技术

- **云开发**: 微信云开发 (wx-server-sdk)
- **云函数**:
  - `user` - 用户登录和管理
  - `qcio` - QCIO 社交功能
  - `chat` - AI 聊天核心
  - `mood_logic` - 心情农场游戏

### AI 能力

- **模型**: 智谱 AI GLM 系列
- **温度参数**: 根据模式动态调整 (0.2-0.95)
- **上下文**: 最近 20 条消息

---

## 数据库设计

### 核心数据表

| 表名 | 用途 |
|------|------|
| users | 用户双代币系统（时光币、网费）、彩蛋收集 |
| qcio_users | QCIO 账号信息 |
| qcio_ai_contacts | AI 好友列表（100个）|
| qcio_groups | 群聊列表（6个）|
| qcio_mood_logs | 用户心情日志 |
| qcio_chat_history | 单人聊天历史 |
| qcio_group_chat_history | 群聊历史 |
| qcio_guestbook | 空间留言板 |
| qcio_daily_tasks | 每日任务（踩一踩记录）|
| qcio_wallet | 用户钱包（金币、Q点）|
| qcio_achievements | 成就系统 |
| mood_garden | 心情农场状态 |

---

## 安全机制

### 内容安全检测

使用微信 `msgSecCheck` API 进行内容安全校验：

- 输入检测：用户发送消息时
- 输出检测：AI 生成回复时

### 发送频率限制

| 限制项 | 数值 |
|--------|------|
| 冷却时间 | 2 秒 |
| 最大输入长度 | 50 字 |

### 数据隔离

- 所有云函数通过 `cloud.getWXContext()` 获取用户 openid
- 数据查询使用 `.where({ _openid: OPENID })` 确保隔离

---

## 项目结构

```
old_story/
├── cloudfunctions/       # 云函数
│   ├── chat/            # AI 聊天核心
│   ├── qcio/            # QCIO 社交功能
│   │   └── modules/     # 功能模块
│   │       ├── wallet.js       # 钱包模块
│   │       ├── dailyTasks.js   # 每日任务
│   │       ├── achievements.js # 成就系统
│   │       ├── moodLog.js      # 心情日志
│   │       └── guestbook.js    # 留言板
│   ├── user/            # 用户管理
│   ├── admin-stats/     # 管理后台数据统计
│   └── mood_logic/      # 心情农场
├── miniprogram/         # 小程序前端
│   ├── pages/           # 页面
│   │   ├── index/       # Windows 98 桌面主页
│   │   ├── chat/        # 单人聊天
│   │   ├── group-chat/  # 群聊
│   │   ├── qcio/        # QCIO 主页
│   │   │   ├── visit/   # 访问他人空间页面
│   │   │   └── components/ # QCIO 组件
│   │   ├── qcio-chat/   # QCIO 聊天
│   │   ├── farm/        # 心情农场
│   │   ├── network-neighborhood/ # 网管系统（双代币、兑换）
│   │   ├── my-computer/ # 我的电脑
│   │   ├── my-documents/ # 我的文档
│   │   ├── recycle-bin/ # 回收站
│   │   ├── browser/     # 浏览器
│   │   ├── tetris/      # 俄罗斯方块
│   │   ├── star-explorer/ # 星际探索
│   │   ├── mars/        # 火星翻译
│   │   ├── avatar/      # 非主流相机
│   │   └── about/       # 关于页面
│   ├── utils/           # 工具函数
│   │   ├── network.js   # 网络状态管理
│   │   └── prevent-duplicate.js # 防重复点击
│   └── components/      # 通用组件
├── admin-panel/         # 管理后台
│   ├── src/             # 源代码
│   │   ├── views/       # 页面组件
│   │   ├── api/         # API 调用
│   │   └── router/      # 路由配置
│   ├── dist/            # 构建产物
│   └── server.js        # Express 服务器
├── docs/                # 文档
│   ├── README.md        # 项目说明
│   ├── FUNCTIONS.md     # 功能说明
│   └── GAMEPLAY.md      # 玩法说明
└── db-init/             # 数据库初始化
    ├── qcio_ai_contacts/  # AI 好友数据
    └── qcio_groups/       # 群聊数据
```

---

## 更新日志

### v2.6 (2025-12-26)
- ✨ 新增双代币系统（时光币 + 网费）
- ✨ 新增桌面彩蛋系统（12个隐藏彩蛋，云端存储）
- ✨ "网上邻居"升级为"网管系统"，支持时光币兑换网费
- 🎮 新用户获得30天免费网费，每日自动扣除1天
- 🎮 探索桌面发现彩蛋，获得时光币奖励
- 🎮 时光币可在网管系统兑换更多网费
- 📊 彩蛋收集进度追踪，成就徽章系统
- 🎨 Win98风格兑换对话框，支持多种套餐

### v2.5 (2025-12-26)
- ✨ 新增管理后台系统 (Vue 3 + Element Plus)
- ✨ 新增 admin-stats 云函数（数据统计）
- 📊 管理后台功能：仪表盘、用户管理、排行榜、创作中心、CDK管理
- 🔧 管理后台部署：Express 服务器 + Nginx 反向代理

### v2.4 (2025-12-25)
- ✨ 优化系统时间弹窗为 Windows 风格日历弹窗（右下角弹出）
- ✨ 新增日历网格显示，支持查看当月所有日期
- ✨ 日期弹窗显示当前时间、星期、农历模拟信息
- 🎨 统一年份为 2005 年（千禧时光机主题）
- 🎨 非主流相机移除"编辑"菜单，优化"帮助"菜单弹窗
- 📝 完善帮助文档说明（基本操作、边框滤镜、装饰功能、小技巧）

### v2.3 (2025-12-25)
- ✨ 优化签到成功弹窗为 Win98 风格自定义对话框
- ✨ 优化注销确认弹窗为 Win98 风格自定义对话框
- ✨ 暂时隐藏农场入口（代码已注释保留）
- 🎨 所有弹窗统一使用 Win98 视觉风格（渐变标题栏、3D 边框、经典按钮）

### v2.2 (2025-12-25)
- ✨ 新增 Windows 98 风格桌面系统
- ✨ 新增网上邻居功能（拨号连接模拟）
- ✨ 新增网络状态管理和错误处理机制
- ✨ 新增小狮子桌面助手（可拖拽互动）
- ✨ 新增开始菜单（带程序子菜单）
- ✨ 优化桌面图标布局（游戏移至开始菜单）
- ✨ 新增任务栏系统托盘（网络状态图标）
- ✨ AI 错误包装（429/超时 → "网络断开"提示）
- 🐛 修复帮助菜单跳转（现跳转至 about/index）
- 🐛 添加点击外部关闭开始菜单功能
- 📝 完善项目文档

### v2.1 (2025-12-25)
- ✨ 新增独立访问页面 (`pages/qcio/visit`)
- ✨ 完善踩一踩系统，每日限制功能
- ✨ 自动留言功能
- ✨ 分享邀请功能
- ✨ 访客统计与最近访客展示
- 🐛 修复关闭按钮样式问题
- 🐛 修复页面返回逻辑
- 📝 完善项目文档

### v2.0 (2025-01)
- QCIO 社交系统完整上线
- 36 种 AI 聊天模式
- 100 个 AI 网友，12 个分组
- 6 个群聊，随机发言机制
- 内容安全检测、频率限制
- 心情农场游戏

### v1.5 (2024-12)
- 千禧浏览器功能
- 火星文翻译器
- 非主流头像生成器
- 星域探险游戏

### v1.0 (2024-12)
- 初始版本发布

---

## 开发指南

### 环境准备

1. 安装微信开发者工具
2. 创建云开发环境
3. 配置 GLM API Key

### 云函数部署

```bash
# 在云函数目录右键 -> 上传并部署
cloudfunctions/chat/
cloudfunctions/qcio/
cloudfunctions/user/
cloudfunctions/mood_logic/
```

### 数据库初始化

需要创建以下数据库集合：

```javascript
// 用户相关
qcio_users
qcio_wallet
qcio_daily_tasks
qcio_achievements
qcio_mood_logs

// 社交相关
qcio_ai_contacts
qcio_groups
qcio_chat_history
qcio_group_chat_history
qcio_guestbook

// 游戏相关
mood_garden
```

然后使用 `db-init/` 目录下的 JSON 文件导入 AI 好友和群聊数据。

---

## 管理后台

管理后台是基于 Vue 3 + Element Plus 构建的 Web 管理系统。

### 功能模块

| 模块 | 说明 |
|------|------|
| 仪表盘 | 用户数据统计、活跃度趋势 |
| 用户管理 | 用户列表、详情查看 |
| 排行榜 | 等级/Q点/彩蛋排行榜 |
| 创作中心 | 排行榜海报生成、AI文案生成 |
| CDK管理 | CDK生成、查看、删除 |

### 部署方式

管理后台部署在服务器独立端口（默认 6688）：

```bash
cd admin-panel
npm install
npm run build
npm run server  # 启动 Express 服务器
```

访问地址：`http://服务器IP:6688`

默认账号：`admin` / `admin123`

### 云函数

管理后台依赖 `admin-stats` 云函数获取数据，部署方式：

1. 微信开发者工具 → 右键 `cloudfunctions/admin-stats`
2. 选择「上传并部署：云端安装依赖」

---

## 常见问题

**Q: 为什么老用户看不到好友？**

A: 老用户可能缺少 `myContacts` 字段。系统会在登录时自动检测并补充分配。

**Q: 群聊显示的成员数不对？**

A: 需要重新导入 `db-init/qcio_groups/groups_import.json` 数据到数据库。

**Q: AI 回复很慢？**

A: 这是正常的，模拟了 2005 年拨号上网的延迟感（开玩笑，实际是 API 调用时间）。

**Q: 踩一踩没有生成留言？**

A: 确保已重新上传 `qcio` 云函数，并且数据库中存在 `qcio_guestbook` 集合。

**Q: 访问页面返回按钮无效？**

A: 已修复，现在会智能判断页面栈，无上一页时返回首页。

---

## 许可证

本项目仅供学习和娱乐使用。

---

## 致敬

本项目致敬：
- QQ 2005 / QQ 空间
- 非主流文化
- 葬爱家族
- 杀马特帝国
- 千禧年代的互联网记忆

> "承諾、絠什嚒用？還bùsんì洅見。"
