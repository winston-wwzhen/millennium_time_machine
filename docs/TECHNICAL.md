# 千禧时光机 - 技术文档汇总

> 本文档整合了数据库设计、经济系统、管理后台、代码优化、合规策略等内容
>
> 整合日期：2025-12-29

---

## 目录

- [一、数据库设计](#一数据库设计)
- [二、经济系统设计](#二经济系统设计)
- [三、管理后台设计](#三管理后台设计)
- [四、代码优化方案](#四代码优化方案)
- [五、工具类定位策略](#五工具类定位策略)
- [六、合规风险处理](#六合规风险处理)

---

## 一、数据库设计

### 1.1 数据库表清单

| 表名 | 用途 | 云函数 |
|------|------|--------|
| `users` | 用户基础信息 | user |
| `qcio_users` | QCIO 账号信息 | qcio |
| `qcio_ai_contacts` | AI 好友列表 | qcio |
| `qcio_groups` | 群聊列表 | qcio |
| `qcio_mood_logs` | 用户心情日志 | qcio |
| `qcio_chat_history` | 单人聊天历史 | qcio |
| `qcio_group_chat_history` | 群聊历史 | qcio |
| `qcio_guestbook` | 空间留言板 | qcio |
| `qcio_wallet` | 用户钱包 | qcio |
| `qcio_transactions` | 交易记录 | qcio |
| `qcio_daily_tasks` | 每日任务 | qcio |
| `qcio_achievements` | 成就定义 | qcio |
| `qcio_user_achievements` | 用户成就记录 | qcio |
| `qcio_user_inventory` | 用户物品 | qcio |
| `qcio_vip_codes` | VIP兑换码 | qcio |
| `qcio_vip_records` | VIP开通记录 | qcio |
| `qcio_farm_profiles` | 农场档案 | qcio |
| `qcio_farm_plots` | 农场土地 | qcio |
| `qcio_farm_inventory` | 农场仓库 | qcio |
| `qcio_farm_logs` | 农场记录 | qcio |
| `mood_garden` | 心情农场 | mood_logic |
| `ifthen_shares` | 游戏分享 | ifthen |
| `ifthen_play_history` | 游戏历史 | ifthen |
| `ifthen_share_visits` | 分享访问 | ifthen |
| `user_transactions` | 用户交易 | user |
| `user_photos` | 用户照片 | user |
| `user_activity_logs` | 用户活动日志 | user |

**总计**：32个数据库集合

### 1.2 核心表结构

#### users - 用户基础信息表

| 字段名 | 类型 | 说明 |
|--------|------|------|
| _openid | String | 微信用户唯一标识 |
| avatarName | String | 用户昵称 |
| netFee | Number | 网费余额（分钟） |
| coins | Number | 时光币余额 |
| discoveredEggs | Array | 已发现的彩蛋ID列表 |
| lastLoginDate | String | 上次登录日期 |
| createTime | Date | 创建时间 |
| updateTime | Date | 更新时间 |

#### qcio_users - QCIO账号信息表

| 字段名 | 类型 | 说明 | 默认值 |
|--------|------|------|--------|
| _openid | String | 微信用户唯一标识 | - |
| qcio_id | String | 5位数字账号 (10000-99999) | 自动生成 |
| password | String | 登录密码 | "123456" |
| nickname | String | 用户昵称 | "千禧网友" |
| signature | String | 个性签名 | 火星文风格 |
| avatar | String | 头像 emoji | "👤" |
| level | Number | 用户等级 | 1 |
| isOnline | Boolean | 在线状态 | false |
| totalVisits | Number | 历史总访问量 | 0 |
| todayVisits | Number | 今日访问量 | 0 |
| recentVisitors | Array | 最近10位访客记录 | [] |
| myContacts | Array | 用户分配到的20个AI好友ID列表 | [] |

#### qcio_ai_contacts - AI好友列表表

| 字段名 | 类型 | 说明 |
|--------|------|------|
| _id | String | 好友唯一标识 |
| name | String | 好友昵称 |
| avatar | String | 头像 emoji |
| status | String | 个性签名 |
| groupName | String | 所属分组名称 |
| groupOrder | Number | 分组排序 |
| contactOrder | Number | 联系人排序 |
| chatMode | String | 聊天模式 |
| isEnabled | Boolean | 是否启用 |

**AI分组列表**（12个分组，100个网友）：

| 分组名 | 人数 | 说明 |
|--------|------|------|
| 葬爱家族 | 22人 | 非主流火星文风格 |
| 网游开黑 | 6人 | 游戏爱好者 |
| 网吧常驻 | 6人 | 技术、网吧相关 |
| 网络评论家 | 7人 | 键盘侠、吐槽 |
| 神秘人士 | 9人 | 玄学、中二、AI |
| 情感咨询 | 6人 | 恋爱、八卦 |
| 学霸联盟 | 7人 | 学习、技术 |
| 文艺青年 | 8人 | 诗歌、古风 |
| 娱乐达人 | 7人 | 电影、音乐、段子 |
| 佛系一族 | 5人 | 禅意、极简 |
| 普通人 | 7人 | 日常生活 |
| 工具人 | 10人 | 转换功能类 |

#### qcio_groups - 群聊列表表

| 字段名 | 类型 | 说明 |
|--------|------|------|
| _id | String | 群唯一标识 |
| name | String | 群名称 |
| avatar | String | 群头像 emoji |
| memberCount | Number | 群成员总数 |
| mode | String | 默认聊天模式 |
| members | Array | 群成员列表 |
| isEnabled | Boolean | 是否启用 |

**群聊列表**（6个群）：

| 群名 | 人数 | 风格 |
|------|------|------|
| 葬爱网游家族 | 24人 | qingwu |
| 网吧技术联盟 | 20人 | netadmin |
| 神秘学园 | 20人 | fortune_teller |
| 情感八卦圈 | 21人 | love_expert |
| 学霸文艺社 | 19人 | nerd |
| 普通生活馆 | 18人 | down_to_earth |

#### qcio_wallet - 用户钱包表

| 字段名 | 类型 | 说明 | 默认值 |
|--------|------|------|--------|
| _openid | String | 微信用户唯一标识 | - |
| coins | Number | 金币余额 | 0 |
| qpoints | Number | Q点余额 | 0 |
| isVip | Boolean | 是否VIP | false |
| vipExpireTime | Date | VIP过期时间 | null |

#### qcio_transactions - 交易记录表

| 字段名 | 类型 | 说明 |
|--------|------|------|
| _id | String | 交易唯一ID |
| _openid | String | 用户 openid |
| type | String | 交易类型 (earn/spend) |
| currency | String | 货币类型 (coins/qpoints) |
| amount | Number | 金额（正数） |
| source | String | 来源/用途 |
| description | String | 描述 |
| balanceAfter | Number | 交易后余额 |
| createTime | Date | 交易时间 |

### 1.3 数据安全

- 所有云函数都通过 `cloud.getWXContext()` 获取用户 openid
- 数据查询均使用 `.where({ _openid: OPENID })` 确保数据隔离
- 内容安全检测使用微信 `msgSecCheck` API

---

## 二、经济系统设计

### 2.1 双代币体系

| 货币 | 名称 | 图标 | 获取方式 | 主要用途 |
|------|------|------|----------|----------|
| 时光币 | Time Coins | 💎 | 发现彩蛋奖励 | 兑换网费、CDK等 |
| 网费 | Network Fee | 🌐 | 初始30天、时光币兑换 | AI 功能消耗 |

### 2.2 时光币获取规则

| 方式 | 数量 | 说明 |
|------|------|------|
| 普通彩蛋 | 400-1000 | 小狮子跳舞、小狮子说话等 |
| 稀有彩蛋 | 1500-2000 | 蓝屏噩梦、隐藏图标 |
| 史诗彩蛋 | 5000 | 深夜党专属 |
| 传说彩蛋 | 10000 | Konami秘籍代码 |

### 2.3 网费获取方式

| 方式 | 数量 | 说明 |
|------|------|------|
| 新用户注册 | 30天（43,200分钟） | 初始赠送 |
| 时光币兑换 | 1天/1000时光币 | 在网管系统兑换 |

### 2.4 兑换比例

- **1000 时光币 = 1 天网费（1440 分钟）**
- 即 **1 时光币 ≈ 1.44 分钟网费**

### 2.5 核心循环

```
新用户注册 → 获得30天免费网费
        ↓
    每日登录 → 自动扣除1天网费
        ↓
  探索桌面 → 发现彩蛋 → 获得时光币
        ↓
  网管系统 → 时光币兑换网费
        ↓
  使用AI功能 → 消耗网费
        ↓
    回到每日登录
```

### 2.6 用户界面设计

**右上角网管插件**：
- 位置：桌面右上角
- 样式：纸质便利贴，低饱和度米色
- 内容：实时显示网费和时光币余额
- 交互：点击打开网管系统，X按钮关闭

**网管系统窗口**：
- 当前网费余额
- 当前时光币余额
- 兑换网费按钮
- 兑换记录
- 扣费记录

---

## 三、管理后台设计

### 3.1 技术方案

#### 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                    Nginx (80/443)                       │
│                   /admin → 6688端口                    │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │   前端 (Node.js + Express 静态服务)             │   │
│  │   Vue 3 + Element Plus                           │   │
│  │   端口：6688                                     │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │   后端 API                                       │   │
│  │   直接调用微信云开发 HTTP API                    │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
└─────────────────────────────────────────────────────────┘
                      │
                      ▼
        ┌───────────────────────────────┐
        │   微信云开发                   │
        │   - 云数据库                   │
        │   - 云函数                     │
        │   - 云存储                     │
        └───────────────────────────────┘
```

### 3.2 技术栈

| 层级 | 技术选型 | 说明 |
|------|----------|------|
| 前端框架 | Vue 3 + Vite | 轻量、快速 |
| UI组件 | Element Plus | 成熟、文档好 |
| 路由 | Vue Router | 官方路由 |
| 状态管理 | Pinia | Vue 3官方推荐 |
| 服务端 | Express + Node.js | 静态文件服务 |
| 反向代理 | Nginx | 已有 |

### 3.3 功能模块

#### P0 核心功能（第一期）

| 模块 | 功能 | 说明 |
|------|------|------|
| 登录 | 管理员登录 | 用户名密码验证 |
| 数据看板 | 核心数据展示 | 用户数、日活、完成数 |
| 用户管理 | 用户列表 | 查看、搜索 |
| 排行榜 | 各类排行 | 等级、Q点、彩蛋 |

#### P1 核心功能（第二期）

| 模块 | 功能 | 说明 |
|------|------|------|
| 内容创作中心 | 海报生成 | 排行榜海报 |
| | AI文案生成 | 多平台文案 |
| CDK管理 | 生成CDK | 批量生成 |
| | 查看使用 | 使用记录 |

### 3.4 云函数设计

| 云函数 | 用途 | 优先级 |
|--------|------|--------|
| admin-login | 管理员登录 | 🔴 P0 |
| admin-stats | 数据统计 | 🔴 P0 |
| admin-users | 用户管理 | 🔴 P0 |
| generate-poster | 生成海报 | 🟡 P1 |
| ai-copywriter | AI文案生成 | 🟡 P1 |
| admin-cdk | CDK管理 | 🟡 P1 |

### 3.5 安全考虑

#### 认证方案

| 方案 | 说明 | 推荐 |
|------|------|------|
| 简单Token | Base64编码，易破解 | 开发阶段 |
| JWT | 标准方案，支持过期 | ✅ 生产环境 |

#### 访问控制

```javascript
// 路由守卫
router.beforeEach((to, from, next) => {
  const token = localStorage.getItem('admin_token')

  if (!token && to.path !== '/login') {
    next('/login')
  } else {
    next()
  }
})
```

### 3.6 访问地址

```
http://你的服务器IP:6688
或
http://你的域名/admin
```

---

## 四、代码优化方案

### 4.1 代码规模分析

#### 超大文件（需要拆分）

| 文件 | 行数 | 优化建议 |
|------|------|---------|
| `pages/index/index.js` | 1542行 | 拆分为8个子模块 |
| `pages/qcio/index.js` | 1073行 | 拆分为5个子模块 |
| `cloudfunctions/qcio/index.js` | 1144行 | 已有modules，继续优化 |
| `cloudfunctions/user/index.js` | 1076行 | 拆分业务模块 |

### 4.2 重复代码分析

#### 云函数调用重复（15+处）

**问题模式**：
```javascript
// 在多个页面重复出现
const res = await wx.cloud.callFunction({
  name: 'user',
  data: { type: 'getBalance' }
});
if (res.result && res.result.success) {
  // 处理数据
}
```

**优化方案**：
使用 `api-client.js`：
```javascript
const { userApi } = require('../../utils/api-client');
const result = await userApi.getBalance();
```

#### setData 重复（80+处）

**问题**：单个属性更新导致多次渲染

**优化方案**：
```javascript
// 不好
this.setData({ a: 1 });
this.setData({ b: 2 });
this.setData({ c: 3 });

// 好
this.setData({ a: 1, b: 2, c: 3 });
```

### 4.3 性能优化方案

#### 首页加载优化

**优化方案**：
1. 合并 setData
2. 使用缓存
3. 预加载常用数据

**预期收益**：
- setData 调用减少 50%
- 首屏加载时间减少 20%
- API 调用减少 30%

### 4.4 公共工具模块

#### 已完成的优化

**api-client.js** - 统一API调用
- userApi - 用户相关API
- qcioApi - QCIO相关API
- chatApi - 聊天相关API
- gameApi - 游戏相关API

**cache-manager.js** - 数据缓存
- userInfoCache - 用户信息缓存
- userBalanceCache - 余额缓存
- qcioContactsCache - AI好友缓存
- qcioProfileCache - QCIO资料缓存

### 4.5 预期收益

#### 代码质量
- 重复代码减少 30%
- 代码可读性提升 40%
- 新功能开发效率提升 50%

#### 性能指标
- 首屏加载时间减少 20%
- setData 调用减少 50%
- API 调用次数减少 30%
- 内存占用减少 15%

---

## 五、工具类定位策略

### 5.1 个人主体小程序限制

| 限制类型 | 具体影响 |
|---------|---------|
| **社交功能** | ❌ 不能做真社交、朋友圈、关注系统 |
| **聊天功能** | ❌ 只能AI聊天，不能真人社交 |
| **支付功能** | ❌ 不能微信支付 |
| **游戏功能** | ❌ 个人主体游戏类目很难过审 |
| **类目限制** | ❌ 很多类目个人主体选不了 |

### 5.2 核心策略：工具类包装

#### 审核话术转换

| 原元素 | 工具类包装 | 审核描述 |
|--------|-----------|---------|
| 游戏玩法 | 历史年表互动体验 | "2005-2025年历史事件回顾工具" |
| 游戏结局 | 人生可能性展示 | "基于历史选择的人生路径模拟器" |
| 属性系统 | 成长维度分析 | "个人成长多维度评估" |
| 重新游戏 | 重新体验 | "探索不同人生路径" |

#### 定位原则

```
审核视角：这是一个"历史年表浏览+人生选择模拟"的教育/回忆工具
         ↓
用户体验：玩法依然是人生模拟游戏，但包装更温和
         ↓
过审关键：弱化"游戏"标签，强化"内容/回忆/选择"
```

### 5.3 UI/文案调整

| 位置 | 原文案 | 建议文案 |
|------|--------|---------|
| 开始按钮 | 开始游戏 | 开始体验 / 回顾历史 |
| 选择提示 | 选择你的角色 | 选择出生年份 |
| 结局标题 | 游戏结束 | 你的2025 / 人生轨迹 |
| 重玩按钮 | 重新开始 | 重新体验 / 探索其他可能 |

### 5.4 需要避免的表述

| 避免使用 | 替代表述 |
|---------|---------|
| "游戏" | "体验"、"模拟"、"回顾" |
| "过关"、"胜利" | "达成"、"完成" |
| "输赢"、"胜负" | "不同结果"、"多种可能" |
| "玩家" | "用户"、"体验者" |
| "排行榜" | "记录"、"统计" |

### 5.5 需要强调的关键词

- **AI** - 强调非真人互动
- **工具** - 强调实用属性
- **回忆** - 强调文化展示
- **体验** - 替代"游戏"
- **经典** - 替代"游戏"
- **程序** - 替代"游戏"

---

## 六、合规风险处理

### 6.1 内容安全检测

使用微信云开发提供的 `msgSecCheck` API 进行内容安全校验：

**检测时机**：
- 用户发送消息时（输入检测）
- AI 生成回复时（输出检测）

**违规处理**：
- 输入违规：返回提示"（系统提示：内容包含敏感词，已被网管屏蔽 v_v）"
- 输出违规：替换为"（内容正在审核中，暂时无法显示...）"

### 6.2 发送频率限制

| 限制项 | 数值 |
|--------|------|
| 冷却时间 | 2000毫秒 (2秒) |
| 超限提示 | "请稍等X秒后再发送" |

### 6.3 输入长度限制

| 页面 | 最大长度 | 超限提示 |
|------|----------|----------|
| 单人聊天 | 50字 | "最多50字" |
| 群聊 | 50字 | "最多50字" |

### 6.4 品牌规范

| 规范 | 说明 |
|------|------|
| 使用 **QCIO** 名称 | 非 QCIQ 或 QQ |
| 明确标注为"怀旧模拟器" | 非真实社交软件 |
| UI 风格致敬但不完全复制 | 避免直接侵权 |

### 6.5 UGC 风险控制

| 内容类型 | 风险等级 | 措施 |
|---------|---------|------|
| 个性签名 | 🟡 中 | 已接入 msgSecCheck |
| 心情日志 | 🟡 中 | 已接入 msgSecCheck |
| 留言板 | 🟢 低 | 目前仅系统预设留言 |
| AI聊天 | 🟢 低 | AI生成内容，无用户对用户通信 |

---

## 参考文档

- 原文档：
  - `数据库设计文档.md`
  - `经济系统设计文档.md`
  - `ADMIN_PANEL.md`
  - `ADMIN_PANEL_IMPLEMENTATION.md`
  - `code-optimization-report.md`
  - `TOOL_CLASS_STRATEGY.md`
  - `合规风险处理手册.md`

---

> © 2025 千禧时光机 · 技术文档汇总
