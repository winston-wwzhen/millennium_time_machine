# åƒç¦§æ—¶å…‰æœº - æ•°æ®åº“è®¾è®¡æ–‡æ¡£

## æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°äº†"åƒç¦§æ—¶å…‰æœº"å¾®ä¿¡å°ç¨‹åºä½¿ç”¨çš„æ‰€æœ‰æ•°æ®åº“è¡¨ç»“æ„ã€å­—æ®µè¯´æ˜åŠå…¶å…³è”å…³ç³»ã€‚

---

## æ•°æ®åº“è¡¨æ¸…å•

| è¡¨å | ç”¨é€” | äº‘å‡½æ•° |
|------|------|--------|
| `users` | ç”¨æˆ·åŸºç¡€ä¿¡æ¯ | user |
| `qcio_users` | QCIO è´¦å·ä¿¡æ¯ | qcio |
| `qcio_mood_logs` | ç”¨æˆ·å¿ƒæƒ…æ—¥å¿— | qcio |
| `qcio_chat_history` | å•äººèŠå¤©å†å² | qcio |
| `qcio_guestbook` | ç©ºé—´ç•™è¨€æ¿ | qcio |
| `mood_garden` | å¿ƒæƒ…å†œåœºæ¸¸æˆçŠ¶æ€ | mood_logic |

---

## è¡¨ç»“æ„è¯¦è§£

### 1. users - ç”¨æˆ·åŸºç¡€ä¿¡æ¯è¡¨

**äº‘å‡½æ•°**: `user`

**ç”¨é€”**: å­˜å‚¨ç”¨æˆ·çš„åŸºç¡€ç™»å½•ä¿¡æ¯

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | å¿…å¡« |
|--------|------|------|------|
| _openid | String | å¾®ä¿¡ç”¨æˆ·å”¯ä¸€æ ‡è¯† | æ˜¯ |
| avatarName | String | ç”¨æˆ·æ˜µç§° | æ˜¯ |
| createTime | Date | åˆ›å»ºæ—¶é—´ | æ˜¯ |
| lastLoginTime | Date | æœ€åç™»å½•æ—¶é—´ | æ˜¯ |
| settings | Object | ç”¨æˆ·è®¾ç½® | å¦ |

**ç´¢å¼•**: `_openid` (ä¸»é”®)

---

### 2. qcio_users - QCIO è´¦å·ä¿¡æ¯è¡¨

**äº‘å‡½æ•°**: `qcio`

**ç”¨é€”**: QCIO ç¤¾äº¤å¹³å°çš„è´¦å·ä¿¡æ¯ï¼ŒåŒ…æ‹¬ä¸ªäººèµ„æ–™ã€åœ¨çº¿çŠ¶æ€ã€ç©ºé—´ç»Ÿè®¡

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | å¿…å¡« | é»˜è®¤å€¼ |
|--------|------|------|------|--------|
| _openid | String | å¾®ä¿¡ç”¨æˆ·å”¯ä¸€æ ‡è¯† | æ˜¯ | - |
| qcio_id | String | 5 ä½æ•°å­—è´¦å· (10000-99999) | æ˜¯ | è‡ªåŠ¨ç”Ÿæˆ |
| password | String | ç™»å½•å¯†ç  (å›ºå®š 123456) | æ˜¯ | "123456" |
| nickname | String | ç”¨æˆ·æ˜µç§° | æ˜¯ | "åƒç¦§ç½‘å‹" |
| signature | String | ä¸ªæ€§ç­¾å | å¦ | "æ‰¿è«¾ã€çµ ä»€åš’ç”¨ï¼Ÿé‚„bÃ¹sã‚“Ã¬æ´…è¦‹ã€‚" |
| avatar | String | å¤´åƒ emoji | æ˜¯ | "ğŸ‘¤" |
| level | Number | ç”¨æˆ·ç­‰çº§ | æ˜¯ | 1 |
| isOnline | Boolean | åœ¨çº¿çŠ¶æ€ | æ˜¯ | false |
| totalVisits | Number | å†å²æ€»è®¿é—®é‡ | æ˜¯ | 0 |
| todayVisits | Number | ä»Šæ—¥è®¿é—®é‡ | æ˜¯ | 0 |
| recentVisitors | Array | æœ€è¿‘ 10 ä½è®¿å®¢è®°å½• | æ˜¯ | [] |
| createTime | Date | è´¦å·åˆ›å»ºæ—¶é—´ | æ˜¯ | serverDate |
| lastLoginTime | Date | æœ€åç™»å½•æ—¶é—´ | æ˜¯ | serverDate |

**ç´¢å¼•**: `_openid` (ä¸»é”®), `qcio_id` (å”¯ä¸€)

**recentVisitors æ•°ç»„ç»“æ„**:
```javascript
{
  visitorId: "12345",      // è®¿å®¢çš„ qcio_id
  visitorName: "è®¿å®¢æ˜µç§°",
  avatar: "ğŸ‘¤",
  visitTime: Date,         // è®¿é—®æ—¶é—´
  timeStr: "åˆšåˆš"          // ç›¸å¯¹æ—¶é—´æè¿°
}
```

---

### 3. qcio_mood_logs - å¿ƒæƒ…æ—¥å¿—è¡¨

**äº‘å‡½æ•°**: `qcio`

**ç”¨é€”**: ç”¨æˆ·åœ¨ QQ ç©ºé—´å‘å¸ƒçš„å¿ƒæƒ…æ—¥å¿—

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | å¿…å¡« |
|--------|------|------|------|
| _openid | String | å‘å¸ƒè€… openid | æ˜¯ |
| mood_type | String | æƒ…ç»ªç±»å‹ (sad/passionate/sweet/confused) | æ˜¯ |
| mood_name | String | æƒ…ç»ªåç§° | æ˜¯ |
| mood_icon | String | æƒ…ç»ªå›¾æ ‡ emoji | æ˜¯ |
| keywords | String | å…³é”®è¯ | å¦ |
| content | String | æ—¥å¿—å†…å®¹ | æ˜¯ |
| createTime | Date | å‘å¸ƒæ—¶é—´ | æ˜¯ |
| visits | Number | è®¿é—®é‡ | æ˜¯ | 0 |
| likes | Number | ç‚¹èµæ•° | æ˜¯ | 0 |

**ç´¢å¼•**: `_openid`, `createTime` (é™åº)

**mood_type å¯¹åº”å…³ç³»**:
| mood_type | mood_icon | è¯´æ˜ |
|-----------|-----------|------|
| sad | ğŸ’” | ä¼¤æ„Ÿ |
| passionate | ğŸ”¥ | çƒ­æƒ… |
| sweet | ğŸ’• | ç”œèœœ |
| confused | ğŸŒ«ï¸ | è¿·èŒ« |

---

### 4. qcio_chat_history - å•äººèŠå¤©å†å²è¡¨

**äº‘å‡½æ•°**: `qcio`

**ç”¨é€”**: å­˜å‚¨ç”¨æˆ·ä¸å•ä¸ªè”ç³»äººçš„èŠå¤©è®°å½•

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | å¿…å¡« |
|--------|------|------|------|
| _openid | String | ç”¨æˆ· openid | æ˜¯ |
| contact_name | String | è”ç³»äººåç§° | æ˜¯ |
| messages | Array | æ¶ˆæ¯åˆ—è¡¨ | æ˜¯ |
| updateTime | Date | æœ€åæ›´æ–°æ—¶é—´ | æ˜¯ |

**ç´¢å¼•**: `_openid` + `contact_name` (å¤åˆå”¯ä¸€ç´¢å¼•)

**messages æ•°ç»„ç»“æ„**:
```javascript
{
  type: "me" | "ai",      // æ¶ˆæ¯ç±»å‹
  content: "æ¶ˆæ¯å†…å®¹",
  timestamp: 1234567890   // æ—¶é—´æˆ³
}
```

---

### 5. qcio_guestbook - ç©ºé—´ç•™è¨€æ¿è¡¨

**äº‘å‡½æ•°**: `qcio`

**ç”¨é€”**: ç”¨æˆ·ç©ºé—´çš„ç•™è¨€è®°å½•ï¼ŒåŒ…æ‹¬"è¸©ä¸€è¸©"è‡ªåŠ¨ç”Ÿæˆçš„ç•™è¨€

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | å¿…å¡« |
|--------|------|------|------|
| _openid | String | ç©ºé—´ä¸»äºº openid | æ˜¯ |
| visitorId | String | è®¿å®¢ qcio_id | æ˜¯ |
| visitorName | String | è®¿å®¢æ˜µç§° | æ˜¯ |
| avatar | String | è®¿å®¢å¤´åƒ emoji | æ˜¯ |
| content | String | ç•™è¨€å†…å®¹ | æ˜¯ |
| createTime | Date | ç•™è¨€æ—¶é—´ | æ˜¯ |

**ç´¢å¼•**: `_openid`, `createTime` (é™åº)

**è‡ªåŠ¨ç•™è¨€å†…å®¹ç¤ºä¾‹**:
- "è·¯è¿‡ï¼Œè¸©è¸©~"
- "æ¥ä¸²ä¸ªé—¨ï¼Œæ”¯æŒä¸‹ï¼"
- "æ‚„æ‚„è·¯è¿‡ï¼Œç•™ä¸ªè„šå°~"
- "è·¯è¿‡æ¥çœ‹çœ‹ï¼Œä¸é”™å“¦~"

---

### 6. mood_garden - å¿ƒæƒ…å†œåœºæ¸¸æˆè¡¨

**äº‘å‡½æ•°**: `mood_logic`

**ç”¨é€”**: å¿ƒæƒ…å†œåœºå°æ¸¸æˆçš„çŠ¶æ€æ•°æ®

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | å¿…å¡« |
|--------|------|------|------|
| _openid | String | ç”¨æˆ· openid | æ˜¯ |
| currentMood | String | å½“å‰ç§æ¤çš„æƒ…ç»ªç±»å‹ | æ˜¯ |
| moodName | String | æƒ…ç»ªåç§° | æ˜¯ |
| startTime | Date | å¼€å§‹ç§æ¤æ—¶é—´ | æ˜¯ |
| endTime | Date | é¢„è®¡æˆç†Ÿæ—¶é—´ | æ˜¯ |
| status | String | çŠ¶æ€ (idle/compiling) | æ˜¯ |
| totalOutput | Number | æ€»äº§é‡ | æ˜¯ | 0 |
| remainingOutput | Number | å‰©ä½™äº§é‡ | æ˜¯ | 0 |
| stealedBy | Array | è¢«å·è®°å½• | æ˜¯ | [] |
| lastModified | Date | æœ€åä¿®æ”¹æ—¶é—´ | æ˜¯ |

**ç´¢å¼•**: `_openid`

**stealedBy æ•°ç»„ç»“æ„**:
```javascript
{
  visitorId: "12345",
  amount: 10,
  time: Date
}
```

---

## æ•°æ®å…³è”å…³ç³»

```mermaid
graph TD
    A[users] --> B[qcio_users]
    B --> C[qcio_mood_logs]
    B --> D[qcio_chat_history]
    B --> E[qcio_guestbook]
    A --> F[mood_garden]
```

**è¯´æ˜**:
- `users` å’Œ `qcio_users` é€šè¿‡ `_openid` å…³è”åŒä¸€ç”¨æˆ·
- `qcio_users` æ˜¯ QCIO åŠŸèƒ½çš„æ ¸å¿ƒè¡¨
- `qcio_mood_logs`ã€`qcio_chat_history`ã€`qcio_guestbook` éƒ½é€šè¿‡ `_openid` å…³è”åˆ°ç”¨æˆ·
- `mood_garden` ç‹¬ç«‹è¿ä½œï¼Œé€šè¿‡ `_openid` å…³è”ç”¨æˆ·

---

## è®¾è®¡è§„èŒƒ

### å‘½åè§„èŒƒ
- è¡¨å: `åŠŸèƒ½æ¨¡å—_å­åŠŸèƒ½` (å¦‚ `qcio_users`)
- å­—æ®µå: é©¼å³°å‘½åæ³• (å¦‚ `lastLoginTime`)
- ç´¢å¼•: ä¸»é”®ä½¿ç”¨ `_openid`

### é€šç”¨å­—æ®µ
- `_openid`: æ‰€æœ‰è¡¨çš„å…³è”å­—æ®µ
- `createTime`: åˆ›å»ºæ—¶é—´ï¼Œç»Ÿä¸€ä½¿ç”¨ `db.serverDate()`
- æ—¶é—´å­—æ®µ: ç»Ÿä¸€ä½¿ç”¨ Date ç±»å‹

### æ•°æ®å®‰å…¨
- æ‰€æœ‰äº‘å‡½æ•°éƒ½é€šè¿‡ `cloud.getWXContext()` è·å–ç”¨æˆ· openid
- æ•°æ®æŸ¥è¯¢å‡ä½¿ç”¨ `.where({ _openid: OPENID })` ç¡®ä¿æ•°æ®éš”ç¦»

---

## ç»´æŠ¤æ—¥å¿—

| æ—¥æœŸ | ç‰ˆæœ¬ | è¯´æ˜ |
|------|------|------|
| 2024-12 | v1.0 | åˆå§‹ç‰ˆæœ¬ï¼Œæ•´ç†æ‰€æœ‰æ•°æ®åº“è¡¨ |
